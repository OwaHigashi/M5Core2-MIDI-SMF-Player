# M5Stack-Core2-MIDI-SMF-Player

## このプログラムが完成するまでの経緯、そして開発停止へ

このアプリケーションは、necobitさんによる、M5Stack用MIDI Module2に対応したMIDIプレイヤーを利用したSMFプレーヤーを、UNIT-SYNTHを装着したCore2で演奏できるように改造したプログラムです。

なお、necobitさんは、@catsinさんのSMFプレーヤーを利用しています。

このプログラムは、実行速度および安定性においてこれ以上の更新が困難とし、開発はM5Core2-SMF-Playerに移行しています。

## どういうプログラムか？

以下は、necobitさんのプログラム中コメントです。

```
// Mini SMF(Standard Midi File) Sequencer Sample Program
// SDカード内に格納したSMFファイルを自動で演奏します。
//
// 以下のI/F/ライブラリを使用します
//  M5Stack用MIDIモジュール2 https://necobit.com/denshi/m5-midi-module2/
//  MSTimer2
//  LovyanGFX
//
// オリジナルは @catsin さんの https://bitbucket.org/kyoto-densouan/smfseq/src/m5stack/
// necobitでは画面描画部分と、起動時自動スタートの処理への変更をしています。
//
//　コメントやコメントアウトなど、取っ散らかっているところがありますがご了承ください。
```

このプログラムでは、次の内容をコメントに追加しています。

```
// 尾和東@Pococha技術枠
// necobit版SMFプレーヤーをUNIT-SYNTHを装着したCore2で演奏するように改造
// さらに、任意のファイル名を受け付けてプレイリストを生成するように修正
```

## 操作方法

画面の下にある3つの仮想ボタンで操作します
- ボタンの反応はそれほどよくありませんので、ぽちっとタッチしたら、ゆるりとお待ちください

- 左のボタン: 前の曲を再生
- 中のボタン: 曲の再生と停止
- 右のボタン: 次の曲を再生
- 下側面のボタン: リセット
- 電源ボタン: クリックでON、長押しでOFF


# UNIT-SYNTHへの対応

これは、シンプルに対応可能です。

次の記述により、MIDIモジュール2に出力されているMIDI情報を、UNIT-SYNTHに送るために、Core2のI2CのSNDピン(32ピン)に情報を振り替えます。これには、次のように記述を追加しています。M5Stack Basic (Core)の場合は、別のピン番号にさらに振り替える必要があります。
```
int MidiPort_open()
{
  MIDI_SERIAL.begin(D_MIDI_PORT_BPS, SERIAL_8N1, -1, 32); // Core2 MIDI 出力をピン32で初期化
  return (0);
}
```

その他、LovyanGFXの利用において仕様変更があったのか、エラーが発生しておりましたので、コンパイルが通るようにinclucdeを調整しました。

# さらなる改造

## 任意のファイル名への対応と再生可能曲数の拡大

オリジナルのプログラムは、SMFファイルのファイル名が固定されており、playlist0.smfから、playlist9.smfまでとなっておりました。

このままでは、利用しにくく、何の曲かもわかりにくいため、この制約を緩和しました。

- '/smf'フォルダの中に含まれる.MID, .mid, .SMF, .smfファイルを検索してプレイリストを自動生成します
- 作成したプレイリストを元に再生します
- デフォルトで管理可能な曲数は100です
- 最大ファイル名の長さは64です
- 仕様としてプレイリストは辞書順になります

## 曲順を戻るボタンを追加

右ボタンで次、真ん中ボタンて停止ですが、左ボタンで戻るができませんでしたので、これに対応しました

# どのように対応したのか？

## 任意のファイル名へ拡張

- まず、次の記述を加えて、基本パラメータを定義しています。これらを変更することで、管理曲数と最大ファイル名を変更できます。
  - 但し、メモリサイズによる制約を受けます

```
// 最大の曲数とファイル名の長さを定義
#define MAX_SONGS 100
#define MAX_FILENAME_LENGTH 64
```
- プレイリストは次の変数に保存されます

```
char songFilenames[MAX_SONGS][MAX_FILENAME_LENGTH]; // 曲のファイル名を格納する配列
```

- 現在再生しているファイル名へのポインタは次に保存されています
```
char *currentFilename = NULL;                       // 現在の曲のファイル名
```

- 新たに```void scanSongs()```関数を追加し、最初にプレイリストを生成しています

## 戻るボタンの追加

makefilename関数は、現在の曲タイトルを生成しますが、同時に再生順序を送るカウンタが設定されていました
- 再生曲はこの関数の結果に依存します

そこで、makefilename関数に引数を追加し、その引数に与えられた数だけカウンタを進める（もしくは戻す）仕様に変更しました

さらに、makefilename関数の呼び出し部分全てについて、引数を与えるようにしました
- 開始時は0
- 次の曲が選択された時は1
- 再生が終わったときも1

さらに、右ボタン(Cボタン)の検出ルーチンをコピーして、左ボタン(Aボタン)の検出を行いました
- 内容はそっくりそのままで、makefilename関数の引数だけ-1にしています

その他、Core2でコンパイル可能なように、コードを一部改変しています

# 制約

- 画面表示も含めて重めのプログラムのため、複雑な曲ではコマ落ちします。コマ落ちが気になる場合は、M5Stack-Simple-SMF-Playerをご利用ください。

- 長い時間再生した場合や、特に複雑な曲を再生した後、タイマ割り込みのタイミングが明らかに不調になり、正しい演奏が行なえなくなる場合があります。高負荷なMIDIファイルの演奏は避けるようにしてください。

# 2048_M5Stack
## M5Core2ライブラリプロジェクト
M5Core2のSD-Updaterを用いたライブラリ集を構築するプロジェクトの一環として実装されています。

# プログラマ

尾和 東/ぽこちゃ技術枠

